---
title: "B12_17(E1E2) treated vs B12(wt)"
format: pdf
editor: visual
---

#Perform DESeq on B12_17(E1E2) treated vs B12(wt)

```{r}
library(DESeq2)
library(ggplot2)
library(tidyverse)
library(tximport)
library(readr)
```

```{r}
metadata_2 <-read.csv("E1E2_metadata_B12vsclone1.csv")
metadata_2 <- as.data.frame(metadata_2)
View(metadata_2)
```

```{r}
count_filtered <- read.csv("gene_counts_filtered10.csv", row.names =1)
count_filtered <- as.data.frame(count_filtered)
View(count_filtered)

```

```{r}
dim(count_filtered)
```

```{r}
dds_B12vsB12_17_treated <-  DESeqDataSetFromMatrix(countData=count_filtered[,c(7:9,1:3)], 
                              colData=metadata_2[c(7:9,1:3),], 
                              design=~treatment)
dds_B12vsB12_17_treated
```

```{r}
dds_B12vsB12_17_treated <- DESeq(dds_B12vsB12_17_treated)

```

```{r}
results_B12vsB12_17_treated <- results(dds_B12vsB12_17_treated)
head(results_B12vsB12_17_treated )
summary(results_B12vsB12_17_treated )

```

```{r}
# Save results to CSV
#write.csv(as.data.frame(results_B12vsB12_17_treated), file = "dds_B12_17treated_vs_B12wt.csv")

```

```{r}
volcano_results_B12vsB12_17_treated <- as.data.frame(results_B12vsB12_17_treated)
# Add row names as the first column named "Genes"
volcano_results_B12vsB12_17_treated$Genes <- rownames(volcano_results_B12vsB12_17_treated)

# Reorder the columns so that "Genes" is the first column
volcano_results_B12vsB12_17_treated <- volcano_results_B12vsB12_17_treated[, c("Genes", setdiff(names(volcano_results_B12vsB12_17_treated), "Genes"))]

# Check the result
head(volcano_results_B12vsB12_17_treated)
```

```{r}
# Add a new column to categorize upregulated, downregulated, and non-significant genes
volcano_results_B12vsB12_17_treated$expression <- ifelse(volcano_results_B12vsB12_17_treated$padj < 0.05 & volcano_results_B12vsB12_17_treated$log2FoldChange > 0, "Upregulated",
                                 ifelse(volcano_results_B12vsB12_17_treated$padj < 0.05 & volcano_results_B12vsB12_17_treated$log2FoldChange < 0, "Downregulated", 
                                        "Not Significant"))

# Create the volcano plot
ggplot(volcano_results_B12vsB12_17_treated , aes(x = log2FoldChange, y = -log10(padj), color = expression)) +
    geom_point() +
    theme_minimal() +
    scale_color_manual(values = c("Upregulated" = "red", "Downregulated" = "blue", "Not Significant" = "gray")) +
    labs(title = "CL1_17(H:F) vs CL1 Volcano Plot", 
         x = "Log2 Fold Change", 
         y = "-Log10 (adjusted p-value)", 
         color = "Expression")+
  ylim(0,400)


```

```{r}
# Load the necessary libraries
library(ggplot2)
library(ggrepel)
library(dplyr)

# Set significance thresholds
significance_threshold <- 0.05
fold_change_threshold <- 0  # Log2 fold change cutoff (adjust as needed)

# Add a new column to categorize upregulated, downregulated, and non-significant genes
volcano_results_B12vsB12_17_treated$expression <- ifelse(volcano_results_B12vsB12_17_treated$padj < significance_threshold & volcano_results_B12vsB12_17_treated$log2FoldChange > fold_change_threshold, "Upregulated",
                                 ifelse(volcano_results_B12vsB12_17_treated$padj < significance_threshold & volcano_results_B12vsB12_17_treated$log2FoldChange < -fold_change_threshold, "Downregulated", 
                                        "Not Significant"))

# Select the top 8 genes based on absolute fold change and adjusted p-value
top_genes <- volcano_results_B12vsB12_17_treated %>%
  filter(padj < significance_threshold) %>%  # Keep only significant genes
  arrange(desc(abs(log2FoldChange)), padj) %>%  # Sort by highest fold change, then lowest adjusted p-value
  slice_head(n = 8)  # Select top 8 genes (adjust as needed)

# Create the volcano plot
ggplot(volcano_results_B12vsB12_17_treated, aes(x = log2FoldChange, y = -log10(padj), color = expression)) +
  geom_point(alpha = 0.7, size = 2) +  # Plot all points
  scale_color_manual(values = c("Upregulated" = "red", "Downregulated" = "blue", "Not Significant" = "gray")) +  # Define colors
  labs(title = "CL1_17 (H:F) vs CL1 Volcano Plot", 
       x = "Log2 Fold Change", 
       y = "-Log10 (adjusted p-value)", 
       color = "Expression") +
  theme_minimal() +
  ylim(0, 400) +  # Set y-axis limits
  geom_hline(yintercept = -log10(significance_threshold), linetype = "dashed", color = "black") +  # P-value cutoff
  geom_vline(xintercept = fold_change_threshold, linetype = "dashed", color = "black") +  # Log2 fold change cutoff
  geom_vline(xintercept = -fold_change_threshold, linetype = "dashed", color = "black") +  # Log2 fold change cutoff
  geom_text_repel(data = top_genes, aes(label = Genes), color = "black", size = 3, max.overlaps = 10)  # Label top genes

# Optionally save the plot
# ggsave("volcano_plot_CL1_17_vs_CL1.png", width = 8, height = 6)
```

